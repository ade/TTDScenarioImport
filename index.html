<!DOCTYPE html>
<html>
<head>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
</head>

<body>
<h3>
    Lat/long with dot decimal
</h3>
<form>
    <p>
        North
        <input type="text" id="north" value="56.6261931"/>
    </p>
    <p>
        South
        <input type="text" id="south" value="55.2771703"/>
    </p>
    <p>
        East
        <input type="text" id="east" value="14.7407328" />
    </p>
    <p>
        West
        <input type="text" id="west" value="12.3704821"/>
    </p>
    <p>
        Max amount of cities (full api allows up to 2000)
        <input type="text" id="maxresults" value="2000"/>
    </p>
    <p>
        Subdivides<br>
        If you are hitting the maximum results, try using this to make multiple requests for the area.
        <select id="subdivides">
            <option value="1">None</option>
            <option value="2">2</option>
            <option value="4">4</option>
            <option value="8">8</option>
        </select>
    </p>
    <p>
        API
        <select id="api">
            <option value="full">Full</option>
            <option value="trimmed">Trimmed</option>
        </select>
    </p>
    <h3>
        Thresholds
    </h3>
    <p>
        Small
        <input type="text" id="pop_small" value="0"/>
    </p>
    <p>
        Medium
        <input type="text" id="pop_medium" value="10000"/>
    </p>
    <p>
        Large
        <input type="text" id="pop_large" value="30000"/>
    </p>
    <p>
        Large + city
        <input type="text" id="pop_large_city" value="50000"/>
    </p>
    <button type="button" id="request">Request</button>
</form>

<div id="status"></div>
<hr />
<div id="output"></div>

<script>
    var endpoint = function(north, south, east, west, maxResults, api) {
        if(api == 'full') {
            return "http://www.geonames.org/servlet/geonames?srv=2&south=" + south + "&north="+north+"&west="+west+"&east="+east+"&P=1&lat="+north+"&lng="+west+"&zoom=12&orderby=population&maxRows=" + maxResults;
        } else {
            return "http://api.geonames.org/citiesJSON?north="+north+"&south="+south+"&east="+east+"&west="+west+"&lang=sv&username=ade_openttd_scenario&maxRows=" + maxResults;
        }
    };

    var boundingBox = function() {
        return {
            north: $('#north').val(),
            south: $('#south').val(),
            east: $('#east').val(),
            west: $('#west').val()
        };
    };

    var startRequest = function() {
        var box = boundingBox();
        var api = $('#api').val();

        $('#status').html('Downloading...');
        $('#output').html('');

        $.ajax({
            url: endpoint(box.north, box.south, box.east, box.west, $('#maxresults').val(), api)
        })
        .done(function(r) {
            var cities;
            if(api == 'full') {
                cities = parseFullApi(r);
            } else {
                cities = parseJsonCitiesApi(r);
            }
            mangle(cities);
        })
        .fail(function() {
            $("#status").html('Sorry, something went wrong');
            $('#output').html('');
        });
    };

    var parseFullApi = function(r) {
        var cities = [];
        $(r).find('geonames marker').each( function(){
            cities.push({
                name: $(this).attr('name'),
                population: parseInt($(this).attr('population'), 10),
                lat: parseFloat($(this).attr('lat')),
                lng: parseFloat($(this).attr('lng'))
            });
        });
        return cities;
    };

    var parseJsonCitiesApi = function(r) {
        return r.geonames;
    };

    var line = function(input) {
        return input + "<br/>";
    };

    var mangle = function(cities) {
        var output = '';
        var box = boundingBox();
        var populations = [];
        var cityData = '';
        var minPop = 999999;
        var maxPop = 0;
        var avgPop = 0;
        var popSum = 0;

        var pop_small = $('#pop_small').val();
        var pop_medium = $('#pop_medium').val();
        var pop_large = $('#pop_large').val();
        var pop_large_city = $('#pop_large_city').val();

        cities.forEach(function(city) {
            var citySize;
            var cityIsCity = '0';
            if(city.population >= pop_large_city) {
                citySize = 'L';
                cityIsCity = '1';
            } else if(city.population >= pop_large) {
                citySize = 'L';
            } else if(city.population >= pop_medium) {
                citySize = 'M';
            } else if(city.population >= pop_small) {
                citySize = 'S';
            }

            cityData += line([
                city.name.replace(/,/g, '.'),
                citySize,
                cityIsCity,
                city.lat,
                city.lng
            ].join(','));

            populations.push(city.population);
            popSum += city.population;
            if(city.population < minPop) {
                minPop = city.population;
            }
            if(city.population > maxPop) {
                maxPop = city.population;
            }
        });

        avgPop = popSum / cities.length;

        output += line('# Bounding box north: ' + box.north + ", east: " + box.east + ", south: " + box.south + ", west: " + box.west);
        output += line(box.north + "," + box.east + "," + box.south + "," + box.west);
        output += line('');
        output += line('# ' + cities.length + " towns");
        output += line('# Total population ' + popSum);
        output += line('# Min population ' + minPop);
        output += line('# Max population ' + maxPop);
        output += line('# Avg population ' + avgPop);

        output += cityData;

        $('#output').html(output);
        $('#status').html('Done!');
    };

    $('#request').click(function() {
        startRequest();
    });
</script>




</body>
</html>